<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <style>
      body {
        margin-top: 50px;
        font-family: -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 15px;
      }
    </style>
    <title>Document</title>
  </head>
  <body>
    <div class="container">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          id="link"
          placeholder="Enter link here"
        />
        <div class="input-group-append">
          <button class="btn btn-info" id="add">
            Add
          </button>
        </div>
      </div>
      <ul class="list-group" id="linklist"></ul>
    </div>
    <script>
      const list = document.querySelector('#linklist');

      function showLinks() {
        storedLinks.forEach(item => addLink(item));
      }

      function addLink(item) {
        const newLink = document.createElement('li');
        newLink.setAttribute('class', 'list-group-item');
        newLink.appendChild(document.createTextNode(item.link));

        const shareButton = document.createElement('button');
        shareButton.setAttribute('class', 'btn btn-outline-primary btn-sm m-2');
        shareButton.innerText = 'Share';

        const removeButton = document.createElement('button');
        removeButton.setAttribute('class', 'btn btn-outline-danger btn-sm');
        removeButton.innerText = 'Remove';

        newLink.appendChild(shareButton);
        newLink.appendChild(removeButton);
        list.prepend(newLink);
      }

      function removeLink(i) {
        linkToRemove = storedLinks.splice(i, 1)[0];
        list.childNodes[list.childNodes.length - i - 1].remove();

        fetch('http://localhost:8080/api/bookmarks/', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(linkToRemove)
        }).then(response => alert(response));
      }

      function openShareWindow(link) {
        window.open('https://www.facebook.com/sharer.php?u=' + link);
      }

      document.addEventListener('DOMContentLoaded', function(event) {
        fetch('http://localhost:8080/api/bookmarks/all')
          .then(response => {
            return response.json();
          })
          .then(json => {
            storedLinks = json;
            showLinks();
          })
          .catch(error => alert('Something went wrong'));

        addButton = document.querySelector('#add');

        addButton.addEventListener('click', function(event) {
          link = document.querySelector('#link');

          if (storedLinks.findIndex(item => item.link === link.value) !== -1) {
            alert('This link is already in the list');
          } else {
            linkItem = { link: link.value, tags: [], text: '' };
            addLink(linkItem);

            fetch('http://localhost:8080/api/bookmarks/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(linkItem)
            })
              .then(response => response.json())
              .then(json => (linkItem._id = json._id));
            storedLinks.push(linkItem);
            link.value = null;
          }
        });

        list.addEventListener('click', function(event) {
          targetLink = event.target.parentNode.firstChild.nodeValue;

          if (event.target.classList.contains('btn-outline-primary')) {
            openShareWindow(targetLink);
          } else if (event.target.classList.contains('btn-outline-danger')) {
            removeLink(storedLinks.findIndex(item => item.link === targetLink));
          }
        });
      });
    </script>
  </body>
</html>
